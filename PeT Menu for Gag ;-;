--[[
üêæ Pet Team Universal (Corrected Version)
Equip + Save/Load Teams + Rename/Delete + Preview Toggle
Original by: MrMeme8 | Code: ChatDev
Improved by: G
--]]

-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")

-- Service Fallback for Executor Environments
local function getService(serviceName)
    local success, service = pcall(function()
        return game:GetService(serviceName)
    end)
    return success and service
end

local PetsService = ReplicatedStorage and ReplicatedStorage:WaitForChild("GameEvents"):WaitForChild("PetsService")

-- Player
local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

--// MODULE: PetTeamManager \\--
local PetTeamManager = {}
PetTeamManager.__index = PetTeamManager

-- Configuration (Easy to edit)
local CONFIG = {
    SAVE_FILE = "PetTeams.json",
    MAX_PETS = 8,
    EQUIP_DELAY = 0.05,
    NOTIFY_DURATION = 2.5,
    UI = {
        Title = "üêæ Pet Team Universal",
        Font = Enum.Font.SourceSansBold,
        Colors = {
            Background = Color3.fromRGB(40, 40, 40),
            Header = Color3.fromRGB(30, 30, 30),
            Primary = Color3.fromRGB(50, 50, 50),
            Secondary = Color3.fromRGB(70, 70, 70),
            Text = Color3.fromRGB(255, 255, 255),
            Success = Color3.fromRGB(0, 150, 0),
            Error = Color3.fromRGB(180, 0, 0),
            Warning = Color3.fromRGB(200, 150, 0),
            Info = Color3.fromRGB(0, 90, 180),
        },
        InitialSize = Vector2.new(550, 340)
    }
}

-- Helper function for creating UI elements
local function CreateElement(className, properties)
    local element = Instance.new(className)
    for prop, value in pairs(properties) do
        element[prop] = value
    end
    return element
end

-- State
PetTeamManager.equippedPets = {}
PetTeamManager.selectedPets = {} -- Using a dictionary for faster lookups: { [uuid] = true }
PetTeamManager.TeamsData = {}
PetTeamManager.previewVisible = true
PetTeamManager.autoSaveEnabled = true
PetTeamManager.isMinimized = false

---
--- üìÇ Data Persistence
---
function PetTeamManager:LoadTeams()
    local data
    if isfile and isfile(CONFIG.SAVE_FILE) then
        local success, result = pcall(function()
            return HttpService:JSONDecode(readfile(CONFIG.SAVE_FILE))
        end)
        if success and type(result) == "table" then
            data = result
        end
    end
    if not data and getgenv().PetTeams then
        data = getgenv().PetTeams
    end
    self.TeamsData = data or {}
end

function PetTeamManager:SaveTeams()
    if not self.autoSaveEnabled then return end
    getgenv().PetTeams = self.TeamsData
    local success, encodedData = pcall(function()
        return HttpService:JSONEncode(self.TeamsData)
    end)
    if success and writefile then
        writefile(CONFIG.SAVE_FILE, encodedData)
    end
end

---
--- üîç Core Logic
---
function PetTeamManager:GetPetToolsByName(prefix)
    local results = {}
    local containers = { player.Backpack, player.Character }
    prefix = prefix:lower()

    for _, container in ipairs(containers) do
        if not container then continue end
        for _, tool in ipairs(container:GetChildren()) do
            if tool:IsA("Tool") and tool.Name:lower():find(prefix, 1, true) then
                local id = tool:GetAttribute("PET_UUID")
                if id then
                    table.insert(results, { id = id, name = tool.Name })
                end
            end
        end
    end
    table.sort(results, function(a, b) return a.name < b.name end)
    return results
end

function PetTeamManager:EquipPets(petsToEquip)
    for _, id in ipairs(petsToEquip) do
        PetsService:FireServer("EquipPet", id, CFrame.new(42, 0, 58))
        if not table.find(self.equippedPets, id) then
            table.insert(self.equippedPets, id)
        end
        task.wait(CONFIG.EQUIP_DELAY)
    end
end

function PetTeamManager:UnequipPets(petsToUnequip)
    local remainingEquipped = {}
    local unequipSet = {}
    for _, id in ipairs(petsToUnequip) do unequipSet[id] = true end

    for _, id in ipairs(self.equippedPets) do
        if unequipSet[id] then
            PetsService:FireServer("UnequipPet", id)
            task.wait(CONFIG.EQUIP_DELAY)
        else
            table.insert(remainingEquipped, id)
        end
    end
    self.equippedPets = remainingEquipped
end

---
--- üé® UI Management & Updates
---
function PetTeamManager:Notify(message, color, duration)
    if not self.UI or not self.UI.NotificationLabel then return end
    local label = self.UI.NotificationLabel
    label.Text = message
    label.BackgroundColor3 = color or CONFIG.UI.Colors.Header
    label.Visible = true
    TweenService:Create(label, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { TextTransparency = 0, BackgroundTransparency = 0.1 }):Play()
    if self.notifyDebounce then task.cancel(self.notifyDebounce) end
    self.notifyDebounce = task.delay(duration or CONFIG.NOTIFY_DURATION, function()
        if label and label.Parent then
            TweenService:Create(label, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.In), { TextTransparency = 1, BackgroundTransparency = 1 }):Play()
        end
    end)
end

function PetTeamManager:RefreshPreview()
    if not self.previewVisible then return end
    local container = self.UI.PreviewList
    container.CanvasPosition = Vector2.zero
    for _, child in ipairs(container:GetChildren()) do
        if child:IsA("GuiObject") then child:Destroy() end
    end
    local prefix = self.UI.PetNameBox.Text
    local pets = self:GetPetToolsByName(prefix)
    for _, pet in ipairs(pets) do
        local isSelected = self.selectedPets[pet.id]
        local btn = CreateElement("TextButton", { Name = pet.id, Text = " " .. pet.name, Parent = container, Size = UDim2.new(1, 0, 0, 22), BackgroundColor3 = isSelected and CONFIG.UI.Colors.Success or CONFIG.UI.Colors.Secondary, TextColor3 = CONFIG.UI.Colors.Text, Font = Enum.Font.SourceSans, TextSize = 15, TextXAlignment = Enum.TextXAlignment.Left })
        btn.MouseButton1Click:Connect(function()
            if self.selectedPets[pet.id] then
                self.selectedPets[pet.id] = nil
                btn.BackgroundColor3 = CONFIG.UI.Colors.Secondary
            else
                local count = 0; for _ in pairs(self.selectedPets) do count += 1 end
                if count < CONFIG.MAX_PETS then
                    self.selectedPets[pet.id] = true
                    btn.BackgroundColor3 = CONFIG.UI.Colors.Success
                else
                    self:Notify(string.format("You can only select up to %d pets.", CONFIG.MAX_PETS), CONFIG.UI.Colors.Error)
                end
            end
        end)
    end
    container.CanvasSize = UDim2.new(0, 0, 0, #pets * 24)
end

function PetTeamManager:RefreshTeams()
    local container = self.UI.TeamList
    container.CanvasPosition = Vector2.zero
    for _, child in ipairs(container:GetChildren()) do
        if child:IsA("Frame") then child:Destroy() end
    end
    local teamNames = {}; for name in pairs(self.TeamsData) do table.insert(teamNames, name) end
    table.sort(teamNames)
    for i, teamName in ipairs(teamNames) do
        local pets = self.TeamsData[teamName]
        local row = CreateElement("Frame", { Name = teamName, Parent = container, Size = UDim2.new(1, 0, 0, 28), BackgroundTransparency = 1 })
        CreateElement("UIListLayout", { Parent = row, FillDirection = Enum.FillDirection.Horizontal, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 4) })
        local eqBtn = CreateElement("TextButton", { Parent = row, Size = UDim2.new(1, -98, 1, 0), Text = "‚ñ∂ " .. teamName, BackgroundColor3 = CONFIG.UI.Colors.Secondary, TextColor3 = CONFIG.UI.Colors.Text, Font = CONFIG.UI.Font, TextXAlignment = Enum.TextXAlignment.Left, TextScaled = true, LayoutOrder = 1 })
        local unBtn = CreateElement("TextButton", { Parent = row, Size = UDim2.new(0, 28, 1, 0), Text = "üì•", BackgroundColor3 = CONFIG.UI.Colors.Warning, TextColor3 = CONFIG.UI.Colors.Text, Font = CONFIG.UI.Font, TextScaled = true, LayoutOrder = 2 })
        local rnBtn = CreateElement("TextButton", { Parent = row, Size = UDim2.new(0, 28, 1, 0), Text = "üìù", BackgroundColor3 = CONFIG.UI.Colors.Info, TextColor3 = CONFIG.UI.Colors.Text, Font = CONFIG.UI.Font, TextScaled = true, LayoutOrder = 3 })
        local delBtn = CreateElement("TextButton", { Parent = row, Size = UDim2.new(0, 28, 1, 0), Text = "üóë", BackgroundColor3 = CONFIG.UI.Colors.Error, TextColor3 = CONFIG.UI.Colors.Text, Font = CONFIG.UI.Font, TextScaled = true, LayoutOrder = 4 })
        eqBtn.MouseButton1Click:Connect(function() self:EquipPets(pets); self:Notify("Equipped team: " .. teamName, CONFIG.UI.Colors.Success) end)
        unBtn.MouseButton1Click:Connect(function() self:UnequipPets(pets); self:Notify("Unequipped team: " .. teamName, CONFIG.UI.Colors.Warning) end)
        delBtn.MouseButton1Click:Connect(function() self.TeamsData[teamName] = nil; self:SaveTeams(); self:RefreshTeams(); self:Notify("Deleted team: " .. teamName, CONFIG.UI.Colors.Error) end)
        rnBtn.MouseButton1Click:Connect(function()
            local input = CreateElement("TextBox", { Parent = row, Size = UDim2.new(1,0,1,0), Position = UDim2.new(), BackgroundColor3 = CONFIG.UI.Colors.Info, Text = teamName, TextColor3 = CONFIG.UI.Colors.Text, Font = CONFIG.UI.Font, TextScaled = true, ClearTextOnFocus = false, ZIndex = 3 }); input:CaptureFocus()
            input.FocusLost:Connect(function(enter)
                if enter and input.Text:len() > 0 and input.Text ~= teamName then
                    if self.TeamsData[input.Text] then self:Notify("A team with that name already exists!", CONFIG.UI.Colors.Error)
                    else self.TeamsData[input.Text] = self.TeamsData[teamName]; self.TeamsData[teamName] = nil; self:SaveTeams(); self:RefreshTeams(); self:Notify("Team renamed to '" .. input.Text .. "'", CONFIG.UI.Colors.Info) end
                end; input:Destroy()
            end)
        end)
    end
    container.CanvasSize = UDim2.new(0, 0, 0, #teamNames * 30)
end

---
--- üöÄ Initialization
---
function PetTeamManager:Init()
    local oldGui = PlayerGui:FindFirstChild("PetTeamUniversal") or CoreGui:FindFirstChild("PetTeamUniversal"); if oldGui then oldGui:Destroy() end
    self.UI = {}
    self.UI.ScreenGui = CreateElement("ScreenGui", { Name = "PetTeamUniversal", Parent = PlayerGui, ResetOnSpawn = false, ZIndexBehavior = Enum.ZIndexBehavior.Sibling })
    self.UI.MainFrame = CreateElement("Frame", { Name = "MainFrame", Parent = self.UI.ScreenGui, Size = UDim2.new(0, CONFIG.UI.InitialSize.X, 0, CONFIG.UI.InitialSize.Y), Position = UDim2.new(0.5, -CONFIG.UI.InitialSize.X / 2, 0.5, -CONFIG.UI.InitialSize.Y / 2), BackgroundColor3 = CONFIG.UI.Colors.Background, Active = true, Draggable = true })
    CreateElement("UICorner", { CornerRadius = UDim.new(0, 6), Parent = self.UI.MainFrame })

    local header = CreateElement("Frame", { Name = "Header", Parent = self.UI.MainFrame, Size = UDim2.new(1, 0, 0, 30), BackgroundColor3 = CONFIG.UI.Colors.Header })
    CreateElement("TextLabel", { Name = "Title", Parent = header, Size = UDim2.new(1, -30, 1, 0), BackgroundColor3 = CONFIG.UI.Colors.Header, Font = CONFIG.UI.Font, Text = CONFIG.UI.Title, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true })
    local minimizeBtn = CreateElement("TextButton", { Name = "MinimizeButton", Parent = header, Size = UDim2.new(0, 30, 1, 0), Position = UDim2.fromScale(1, 0), AnchorPoint = Vector2.new(1, 0), BackgroundColor3 = CONFIG.UI.Colors.Secondary, Text = "‚àí", Font = CONFIG.UI.Font, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true })
    
    local contentFrame = CreateElement("Frame", { Name = "Content", Parent = self.UI.MainFrame, Size = UDim2.new(1, -10, 1, -40), Position = UDim2.new(0.5, 0, 0, 35), AnchorPoint = Vector2.new(0.5, 0), BackgroundTransparency = 1 })

    local leftCol = CreateElement("Frame", { Name = "LeftColumn", Parent = contentFrame, Size = UDim2.new(0.33, -5, 1, 0), Position = UDim2.fromScale(0, 0), BackgroundTransparency = 1 }); CreateElement("UIListLayout", { Parent = leftCol, Padding = UDim.new(0, 5), SortOrder = Enum.SortOrder.LayoutOrder })
    local midCol = CreateElement("Frame", { Name = "MidColumn", Parent = contentFrame, Size = UDim2.new(0.33, -5, 1, 0), Position = UDim2.fromScale(0.33, 0), BackgroundTransparency = 1 })
    local rightCol = CreateElement("Frame", { Name = "RightColumn", Parent = contentFrame, Size = UDim2.new(0.33, 0, 1, 0), Position = UDim2.fromScale(0.66, 0), BackgroundTransparency = 1 }); CreateElement("UIListLayout", { Parent = rightCol, Padding = UDim.new(0, 5), SortOrder = Enum.SortOrder.LayoutOrder })
    
    self.UI.PetNameBox = CreateElement("TextBox", { Parent = leftCol, Size = UDim2.new(1, 0, 0, 30), PlaceholderText = "Filter by Pet Name", Font = CONFIG.UI.Font, BackgroundColor3 = CONFIG.UI.Colors.Secondary, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true, LayoutOrder = 1 })
    self.UI.NumberBox = CreateElement("TextBox", { Parent = leftCol, Size = UDim2.new(1, 0, 0, 30), PlaceholderText = "Equip Count (e.g., 4)", Font = CONFIG.UI.Font, BackgroundColor3 = CONFIG.UI.Colors.Secondary, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true, Text = tostring(CONFIG.MAX_PETS), LayoutOrder = 2 })
    local equipBtn = CreateElement("TextButton", { Parent = leftCol, Size = UDim2.new(1, 0, 0, 30), Text = "Equip Filtered/Selected", Font = CONFIG.UI.Font, BackgroundColor3 = CONFIG.UI.Colors.Success, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true, LayoutOrder = 3 })
    local unequipAllBtn = CreateElement("TextButton", { Parent = leftCol, Size = UDim2.new(1, 0, 0, 30), Text = "Unequip All", Font = CONFIG.UI.Font, BackgroundColor3 = CONFIG.UI.Colors.Error, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true, LayoutOrder = 4 })
    local togglePreviewBtn = CreateElement("TextButton", { Parent = leftCol, Size = UDim2.new(1, 0, 0, 30), Text = "üëÅ Preview: ON", Font = CONFIG.UI.Font, BackgroundColor3 = CONFIG.UI.Colors.Success, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true, LayoutOrder = 5 })
    
    self.UI.PreviewList = CreateElement("ScrollingFrame", { Parent = midCol, Size = UDim2.new(1, 0, 1, 0), BackgroundColor3 = CONFIG.UI.Colors.Primary, ScrollBarThickness = 8, CanvasSize = UDim2.new(), BorderSizePixel = 0 }); CreateElement("UICorner", { Parent = self.UI.PreviewList }); CreateElement("UIListLayout", { Parent = self.UI.PreviewList, Padding = UDim.new(0, 2), SortOrder = Enum.SortOrder.Name })

    local teamContainer = CreateElement("Frame", { Parent = rightCol, Size = UDim2.new(1, 0, 1, 0), BackgroundColor3 = CONFIG.UI.Colors.Primary, BorderSizePixel = 0 }); CreateElement("UICorner", { Parent = teamContainer }); CreateElement("UIPadding", { PaddingLeft = UDim.new(0, 5), PaddingRight = UDim.new(0, 5), PaddingTop = UDim.new(0, 5), PaddingBottom = UDim.new(0, 5), Parent = teamContainer })
    self.UI.TeamList = CreateElement("ScrollingFrame", { Parent = teamContainer, Size = UDim2.new(1, 0, 1, -75), BackgroundColor3 = CONFIG.UI.Colors.Background, BorderSizePixel = 0, ScrollBarThickness = 8 }); CreateElement("UIListLayout", { Parent = self.UI.TeamList, Padding = UDim.new(0, 2) })
    local saveTeamBtn = CreateElement("TextButton", { Parent = teamContainer, Size = UDim2.new(1, 0, 0, 30), Position = UDim2.new(0, 0, 1, -35), Text = "Save Selected as Team", Font = CONFIG.UI.Font, BackgroundColor3 = CONFIG.UI.Colors.Success, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true })
    CreateElement("TextLabel", { Parent = teamContainer, Size = UDim2.new(1, 0, 0, 30), Position = UDim2.new(-1.65, 0, 1, 0), AnchorPoint = Vector2.new(0.5, 1), Text = "[UI MrMeme8] [System ChatDev] [Improvements G]", BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(180, 180, 180), Font = Enum.Font.SourceSansItalic, TextScaled = true })

    self.UI.NotificationLabel = CreateElement("TextLabel", { Parent = self.UI.ScreenGui, Size = UDim2.new(0, 320, 0, 45), Position = UDim2.new(0.5, -160, 0.85, 0), BackgroundColor3 = CONFIG.UI.Colors.Header, BackgroundTransparency = 1, TextColor3 = CONFIG.UI.Colors.Text, TextTransparency = 1, Font = CONFIG.UI.Font, TextScaled = true, Visible = false, ZIndex = 10 }); CreateElement("UICorner", { Parent = self.UI.NotificationLabel })

    self:LoadTeams(); self:RefreshTeams(); self:RefreshPreview()

    minimizeBtn.MouseButton1Click:Connect(function()
        self.isMinimized = not self.isMinimized
        contentFrame.Visible = not self.isMinimized
        minimizeBtn.Text = self.isMinimized and "+" or "‚àí"
        self.UI.MainFrame.Size = self.isMinimized and UDim2.new(0, 200, 0, 30) or UDim2.new(0, CONFIG.UI.InitialSize.X, 0, CONFIG.UI.InitialSize.Y)
    end)
    togglePreviewBtn.MouseButton1Click:Connect(function()
        self.previewVisible = not self.previewVisible
        midCol.Visible = self.previewVisible
        togglePreviewBtn.Text = self.previewVisible and "üåï Preview: ON" or "üåë Preview: OFF"
        togglePreviewBtn.BackgroundColor3 = self.previewVisible and CONFIG.UI.Colors.Success or CONFIG.UI.Colors.Error
        if self.previewVisible then self:RefreshPreview() end
    end)
    self.UI.PetNameBox:GetPropertyChangedSignal("Text"):Connect(function() self:RefreshPreview() end)
    equipBtn.MouseButton1Click:Connect(function()
        local numToEquip = tonumber(self.UI.NumberBox.Text) or CONFIG.MAX_PETS; numToEquip = math.clamp(numToEquip, 1, CONFIG.MAX_PETS); local toEquip = {}
        for id, _ in pairs(self.selectedPets) do if #toEquip < numToEquip then table.insert(toEquip, id) end end
        if #toEquip < numToEquip then
            local filteredPets = self:GetPetToolsByName(self.UI.PetNameBox.Text)
            for _, pet in ipairs(filteredPets) do if #toEquip >= numToEquip then break end; if not self.selectedPets[pet.id] then table.insert(toEquip, pet.id) end end
        end
        if #toEquip > 0 then self:EquipPets(toEquip); self:Notify(string.format("Equipped %d pet(s).", #toEquip), CONFIG.UI.Colors.Success)
        else self:Notify("No pets found or selected to equip.", CONFIG.UI.Colors.Warning) end
    end)
    unequipAllBtn.MouseButton1Click:Connect(function()
        if #self.equippedPets == 0 then self:Notify("No pets are currently equipped.", CONFIG.UI.Colors.Warning); return end
        local petsToUnequip = table.clone(self.equippedPets)
        self:UnequipPets(petsToUnequip)
        self.equippedPets = {}
        self:Notify(string.format("Unequipped %d pet(s).", #petsToUnequip), CONFIG.UI.Colors.Error)
    end)
    saveTeamBtn.MouseButton1Click:Connect(function()
        local selectedIds = {}; for id, _ in pairs(self.selectedPets) do table.insert(selectedIds, id) end
        if #selectedIds == 0 then self:Notify("Select pets in the preview list to save a team.", CONFIG.UI.Colors.Warning); return end
        local inputFrame = CreateElement("Frame", { Parent = self.UI.MainFrame, Size = UDim2.new(1,0,1,0), BackgroundColor3 = Color3.new(0,0,0), BackgroundTransparency = 0.4, ZIndex = 2 })
        local inputBox = CreateElement("TextBox", { Parent = inputFrame, Size = UDim2.new(0.5, 0, 0, 40), Position = UDim2.fromScale(0.5, 0.4), AnchorPoint = Vector2.new(0.5, 0.5), PlaceholderText = "Enter New Team Name...", Font = CONFIG.UI.Font, BackgroundColor3 = CONFIG.UI.Colors.Secondary, TextColor3 = CONFIG.UI.Colors.Text, TextScaled = true }); inputBox:CaptureFocus()
        inputBox.FocusLost:Connect(function(enter)
            if enter and inputBox.Text:len() > 0 then
                local teamName = inputBox.Text
                if self.TeamsData[teamName] then self:Notify("A team with that name already exists.", CONFIG.UI.Colors.Error)
                else self.TeamsData[teamName] = selectedIds; self:SaveTeams(); self:RefreshTeams(); self:Notify("Saved team: " .. teamName, CONFIG.UI.Colors.Success); self.selectedPets = {}; self:RefreshPreview() end
            end
            inputFrame:Destroy()
        end)
    end)
end

PetTeamManager:Init()    lbl.TextColor3 = Color3.fromRGB(255,255,255)
    lbl.Font = Enum.Font.SourceSansBold
    lbl.TextScaled = true
    lbl.Text = msg
    task.delay(2,function() gui:Destroy() end)
end

-- üßπ Clear old GUI
local old = PlayerGui:FindFirstChild("PetTeamUniversal") or CoreGui:FindFirstChild("PetTeamUniversal")
if old then old:Destroy() end

-- üé® GUI Root
local screenGui = Instance.new("ScreenGui")
screenGui.Name="PetTeamUniversal"
screenGui.ResetOnSpawn=false
screenGui.Parent=PlayerGui

local frame = Instance.new("Frame",screenGui)
frame.Size=UDim2.new(0,550,0,340)
frame.Position=UDim2.new(0.5,-275,0.5,-170)
frame.BackgroundColor3=Color3.fromRGB(40,40,40)
frame.Active=true frame.Draggable=true

local title=Instance.new("TextLabel",frame)
title.Size=UDim2.new(1,-30,0,30)
title.Text="üêæ Pet Team Universal"
title.BackgroundColor3=Color3.fromRGB(30,30,30)
title.TextColor3=Color3.new(1,1,1)
title.Font=Enum.Font.SourceSansBold
title.TextScaled=true

local minimizeBtn=Instance.new("TextButton",frame)
minimizeBtn.Size=UDim2.new(0,30,0,30)
minimizeBtn.Position=UDim2.new(1,-30,0,0)
minimizeBtn.Text="‚àí"
minimizeBtn.BackgroundColor3=Color3.fromRGB(60,60,60)
minimizeBtn.TextColor3=Color3.new(1,1,1)
minimizeBtn.Font=Enum.Font.SourceSansBold
minimizeBtn.TextScaled=true

local minimized=false
minimizeBtn.MouseButton1Click:Connect(function()
    minimized=not minimized
    for _,o in ipairs(frame:GetChildren()) do
        if o~=title and o~=minimizeBtn then o.Visible=not minimized end
    end
    frame.Size=minimized and UDim2.new(0,200,0,30) or UDim2.new(0,550,0,340)
    minimizeBtn.Text=minimized and "+" or "‚àí"
end)

-- Inputs
local petNameBox=Instance.new("TextBox",frame)
petNameBox.Size=UDim2.new(0.33,-10,0,30)
petNameBox.Position=UDim2.new(0,5,0,35)
petNameBox.PlaceholderText="Enter Pet Tool Name"
petNameBox.BackgroundColor3=Color3.fromRGB(70,70,70)
petNameBox.TextColor3=Color3.new(1,1,1)
petNameBox.Font=Enum.Font.SourceSansBold
petNameBox.TextScaled=true

local numberBox=Instance.new("TextBox",frame)
numberBox.Size=UDim2.new(0.33,-10,0,30)
numberBox.Position=UDim2.new(0,5,0,70)
numberBox.PlaceholderText="Enter 1-8"
numberBox.BackgroundColor3=Color3.fromRGB(70,70,70)
numberBox.TextColor3=Color3.new(1,1,1)
numberBox.Font=Enum.Font.SourceSansBold
numberBox.TextScaled=true

-- Buttons
local equipBtn=Instance.new("TextButton",frame)
equipBtn.Size=UDim2.new(0.33,-10,0,30)
equipBtn.Position=UDim2.new(0,5,0,105)
equipBtn.BackgroundColor3=Color3.fromRGB(0,120,0)
equipBtn.Text="Equip Pet(s)"
equipBtn.TextColor3=Color3.new(1,1,1)
equipBtn.Font=Enum.Font.SourceSansBold
equipBtn.TextScaled=true

local unequipAllBtn=Instance.new("TextButton",frame)
unequipAllBtn.Size=UDim2.new(0.33,-10,0,30)
unequipAllBtn.Position=UDim2.new(0,5,0,140)
unequipAllBtn.BackgroundColor3=Color3.fromRGB(180,0,0)
unequipAllBtn.Text="Unequip ALL"
unequipAllBtn.TextColor3=Color3.new(1,1,1)
unequipAllBtn.Font=Enum.Font.SourceSansBold
unequipAllBtn.TextScaled=true

-- üëÅ Toggle Preview
local previewFrame = Instance.new("ScrollingFrame",frame)
previewFrame.Size=UDim2.new(0.33,-10,1,-40)
previewFrame.Position=UDim2.new(0.33,5,0,35)
previewFrame.BackgroundColor3=Color3.fromRGB(50,50,50)
previewFrame.ScrollBarThickness=6
previewFrame.CanvasSize=UDim2.new(0,0,0,0)

local togglePreview=Instance.new("TextButton",frame)
togglePreview.Size=UDim2.new(0.33,-10,0,30)
togglePreview.Position=UDim2.new(0,5,0,175) -- moved under Unequip ALL
togglePreview.Text="üëÅ Preview: ON"
togglePreview.BackgroundColor3=Color3.fromRGB(0,120,0)
togglePreview.TextColor3=Color3.new(1,1,1)
togglePreview.Font=Enum.Font.SourceSansBold
togglePreview.TextScaled=true

togglePreview.MouseButton1Click:Connect(function()
    previewVisible=not previewVisible
    previewFrame.Visible=previewVisible
    togglePreview.Text=previewVisible and "üëÅ Preview: ON" or "üëÅ Preview: OFF"
    togglePreview.BackgroundColor3=previewVisible and Color3.fromRGB(0,120,0) or Color3.fromRGB(180,0,0)
    if previewVisible then refreshPreview(petNameBox.Text) end
end)

-- Teams
local teamFrame=Instance.new("Frame",frame)
teamFrame.Size=UDim2.new(0.33,-10,1,-40)
teamFrame.Position=UDim2.new(0.66,5,0,35)
teamFrame.BackgroundColor3=Color3.fromRGB(55,55,55)

local teamList=Instance.new("ScrollingFrame",teamFrame)
teamList.Size=UDim2.new(1,-10,1,-80)
teamList.Position=UDim2.new(0,5,0,5)
teamList.ScrollBarThickness=6

local saveTeamBtn=Instance.new("TextButton",teamFrame)
saveTeamBtn.Size=UDim2.new(1,-10,0,30)
saveTeamBtn.Position=UDim2.new(0,5,1,-70)
saveTeamBtn.Text="Save Team"
saveTeamBtn.BackgroundColor3=Color3.fromRGB(0,120,0)
saveTeamBtn.TextColor3=Color3.new(1,1,1)
saveTeamBtn.Font=Enum.Font.SourceSansBold
saveTeamBtn.TextScaled=true

local credits=Instance.new("TextLabel",teamFrame)
credits.Size=UDim2.new(1,-10,0,30)
credits.Position=UDim2.new(0,5,1,-35)
credits.BackgroundTransparency=1
credits.Text="Made by MrMeme8 | Code: ChatDev"
credits.TextColor3=Color3.fromRGB(200,200,200)
credits.Font=Enum.Font.SourceSansItalic
credits.TextScaled=true

-- üîÑ Refresh Preview
function refreshPreview(prefix)
    for _,c in ipairs(previewFrame:GetChildren()) do
        if c:IsA("TextButton") then c:Destroy() end
    end
    local pets=getPetToolsByName(prefix)
    previewFrame.CanvasSize=UDim2.new(0,0,0,#pets*22)
    for i,pet in ipairs(pets) do
        local btn=Instance.new("TextButton",previewFrame)
        btn.Size=UDim2.new(1,-5,0,20)
        btn.Position=UDim2.new(0,2,0,(i-1)*22)
        btn.BackgroundColor3=table.find(selectedPets,pet.id) and Color3.fromRGB(0,120,0) or Color3.fromRGB(60,60,60)
        btn.Text=pet.name
        btn.TextColor3=Color3.new(1,1,1)
        btn.Font=Enum.Font.SourceSans
        btn.TextSize=16

        btn.MouseButton1Click:Connect(function()
            if table.find(selectedPets,pet.id) then
                for j,id in ipairs(selectedPets) do
                    if id==pet.id then table.remove(selectedPets,j) break end
                end
                btn.BackgroundColor3=Color3.fromRGB(60,60,60)
            else
                if #selectedPets<8 then
                    table.insert(selectedPets,pet.id)
                    btn.BackgroundColor3=Color3.fromRGB(0,120,0)
                else
                    notify("Max 8 pets!",Color3.fromRGB(180,0,0))
                end
            end
        end)
    end
end

-- üîÑ Refresh Teams
function refreshTeams()
    for _,c in ipairs(teamList:GetChildren()) do if c:IsA("Frame") then c:Destroy() end end
    local i=0
    for teamName,pets in pairs(TeamsData) do
        i+=1
        local row=Instance.new("Frame",teamList)
        row.Size=UDim2.new(1,-5,0,28)
        row.Position=UDim2.new(0,2,0,(i-1)*30)
        row.BackgroundTransparency=1

        local eqBtn=Instance.new("TextButton",row)
        eqBtn.Size=UDim2.new(0.5,-5,1,0)
        eqBtn.Text="‚ñ∂ "..teamName
        eqBtn.BackgroundColor3=Color3.fromRGB(80,80,80)
        eqBtn.TextColor3=Color3.new(1,1,1)
        eqBtn.Font=Enum.Font.SourceSansBold
        eqBtn.TextScaled=true

        local unBtn=Instance.new("TextButton",row)
        unBtn.Size=UDim2.new(0.2,-5,1,0)
        unBtn.Position=UDim2.new(0.5,5,0,0)
        unBtn.Text="‚èπ"
        unBtn.BackgroundColor3=Color3.fromRGB(180,0,0)
        unBtn.TextColor3=Color3.new(1,1,1)

        local rnBtn=Instance.new("TextButton",row)
        rnBtn.Size=UDim2.new(0.15,-5,1,0)
        rnBtn.Position=UDim2.new(0.7,5,0,0)
        rnBtn.Text="‚úèÔ∏è"
        rnBtn.BackgroundColor3=Color3.fromRGB(0,90,180)
        rnBtn.TextColor3=Color3.new(1,1,1)

        local delBtn=Instance.new("TextButton",row)
        delBtn.Size=UDim2.new(0.15,-5,1,0)
        delBtn.Position=UDim2.new(0.85,5,0,0)
        delBtn.Text="‚ùå"
        delBtn.BackgroundColor3=Color3.fromRGB(150,0,0)
        delBtn.TextColor3=Color3.new(1,1,1)

        eqBtn.MouseButton1Click:Connect(function()
            equippedPets={}
            for _,id in ipairs(pets) do
                PetsService:FireServer("EquipPet",id,position)
                table.insert(equippedPets,id)
                task.wait(0.1)
            end
            notify("Equipped team: "..teamName,Color3.fromRGB(0,120,0))
        end)

        unBtn.MouseButton1Click:Connect(function()
            for _,id in ipairs(pets) do
                PetsService:FireServer("UnequipPet",id)
                task.wait(0.1)
            end
            notify("Unequipped team: "..teamName,Color3.fromRGB(180,0,0))
        end)

        rnBtn.MouseButton1Click:Connect(function()
            local inputBox=Instance.new("TextBox",row)
            inputBox.Size=UDim2.new(1,0,1,0)
            inputBox.Text=teamName
            inputBox.BackgroundColor3=Color3.fromRGB(100,100,100)
            inputBox.TextColor3=Color3.new(1,1,1)
            inputBox.Font=Enum.Font.SourceSansBold
            inputBox.TextScaled=true
            inputBox.FocusLost:Connect(function(enter)
                if enter and inputBox.Text~="" then
                    if TeamsData[inputBox.Text] then
                        notify("Name already exists!",Color3.fromRGB(180,0,0))
                    else
                        TeamsData[inputBox.Text]=TeamsData[teamName]
                        TeamsData[teamName]=nil
                        saveTeams()
                        refreshTeams()
                        notify("Renamed to: "..inputBox.Text,Color3.fromRGB(0,90,180))
                    end
                end
                inputBox:Destroy()
            end)
        end)

        delBtn.MouseButton1Click:Connect(function()
            TeamsData[teamName]=nil
            saveTeams()
            refreshTeams()
            notify("Deleted team: "..teamName,Color3.fromRGB(180,0,0))
        end)
    end
    teamList.CanvasSize=UDim2.new(0,0,0,i*30)
end

-- üîò Logic
equipBtn.MouseButton1Click:Connect(function()
    local prefix=petNameBox.Text
    local num=tonumber(numberBox.Text) or 8
    num=math.clamp(num,1,8)
    local pets=getPetToolsByName(prefix)
    if #pets==0 then return end
    equippedPets={}
    local count=0
    for _,id in ipairs(selectedPets) do
        if count<num then
            PetsService:FireServer("EquipPet",id,position)
            table.insert(equippedPets,id)
            count+=1
            task.wait(0.1)
        end
    end
    for _,p in ipairs(pets) do
        if count>=num then break end
        if not table.find(selectedPets,p.id) then
            PetsService:FireServer("EquipPet",p.id,position)
            table.insert(equippedPets,p.id)
            count+=1
            task.wait(0.1)
        end
    end
end)

unequipAllBtn.MouseButton1Click:Connect(function()
    for _,id in ipairs(equippedPets) do
        PetsService:FireServer("UnequipPet",id)
        task.wait(0.1)
    end
    equippedPets={}
end)

saveTeamBtn.MouseButton1Click:Connect(function()
    if #selectedPets==0 then return end
    local inputBox=Instance.new("TextBox",teamFrame)
    inputBox.Size=UDim2.new(1,-10,0,30)
    inputBox.Position=UDim2.new(0,5,1,-110)
    inputBox.PlaceholderText="Enter Team Name"
    inputBox.BackgroundColor3=Color3.fromRGB(100,100,100)
    inputBox.TextColor3=Color3.new(1,1,1)
    inputBox.Font=Enum.Font.SourceSansBold
    inputBox.TextScaled=true
    inputBox.FocusLost:Connect(function(enter)
        if enter and inputBox.Text~="" then
            if TeamsData[inputBox.Text] then
                notify("Name already exists!",Color3.fromRGB(180,0,0))
            else
                TeamsData[inputBox.Text]=table.clone(selectedPets)
                saveTeams()
                refreshTeams()
                notify("Saved team: "..inputBox.Text,Color3.fromRGB(0,120,0))
                selectedPets={} -- clear after save
                refreshPreview(petNameBox.Text)
            end
        end
        inputBox:Destroy()
    end)
end)

-- Auto refresh preview
petNameBox:GetPropertyChangedSignal("Text"):Connect(function()
    if previewVisible then refreshPreview(petNameBox.Text) end
end)

-- Init
loadTeams()
refreshTeams()
refreshPreview("")

-- Manual Resize Controls (Width & Height)
local resizeFrame = Instance.new("Frame", frame)
resizeFrame.Size = UDim2.new(0.33, -10, 0, 35)
resizeFrame.Position = UDim2.new(0, 5, 1, -40)
resizeFrame.BackgroundColor3 = Color3.fromRGB(60,60,60)

local widthBox = Instance.new("TextBox", resizeFrame)
widthBox.Size = UDim2.new(0.5, -5, 1, -5)
widthBox.Position = UDim2.new(0, 5, 0, 3)
widthBox.PlaceholderText = "Width"
widthBox.Text = tostring(frame.Size.X.Offset)
widthBox.BackgroundColor3 = Color3.fromRGB(80,80,80)
widthBox.TextColor3 = Color3.new(1,1,1)

local heightBox = Instance.new("TextBox", resizeFrame)
heightBox.Size = UDim2.new(0.5, -5, 1, -5)
heightBox.Position = UDim2.new(0.5, 5, 0, 3)
heightBox.PlaceholderText = "Height"
heightBox.Text = tostring(frame.Size.Y.Offset)
heightBox.BackgroundColor3 = Color3.fromRGB(80,80,80)
heightBox.TextColor3 = Color3.new(1,1,1)

-- Apply Resize
local function applyResize()
    local newW = tonumber(widthBox.Text) or frame.Size.X.Offset
    local newH = tonumber(heightBox.Text) or frame.Size.Y.Offset
    frame.Size = UDim2.new(0, newW, 0, newH)
    frame.Position = UDim2.new(0.5, -newW/2, 0.5, -newH/2)
end

widthBox.FocusLost:Connect(applyResize)
heightBox.FocusLost:Connect(applyResize)
